type indexType:  (0..3)
type regType: array indexType of bool

-------------------------------------------------------------------------------------
--
--   SPECIFICATION
--
-------------------------------------------------------------------------------------
{\small

\begin{figure}
\begin{mtab}{l}

\MODULE \Spec\\
\qu \INTF \grant, \half_empty:\bool; \grant_index:indexType; \alloc:regType \\
\qu \EXTL \req, \free, \high_priority:\bool; \free_index:indexType \\
  
\qu \ATOM \ALLOC \CONTROLS \alloc 
	\READS  \alloc 
	\AWAITS \req, \grant, \grant_index, \free, \free_index \\
\qqu \INIT\\
\qqu \begin{chtab}
	\true -> \forall i \alloc'[i] := \false
     \end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab}
	\true -> \forall i 
		   \alloc'[i] := 
		     \if (\grant' & \grant_index' = i) \then \true
		     \else \if (\free' & \free_index' = i) \then \false
		     \else \alloc[i] \fi \fi 
     \end{chtab} \\
\qu \ENDA \\
\qu \ATOM \HALF_EMPTY \CONTROLS \half_empty
	\READS \alloc \\
\qqu \INIT \\
\qqu \begin{chtab}
	\true -> \half_empty' := \true
     \end{chtab} \\
\qqu \update \\
\qqu \begin{chtab}
	~\alloc[0]  -> \half_empty' := \if (~\alloc[1] | ~\alloc[2] | ~\alloc[3]) \then \true
					 \else \false \fi \\
 	~\alloc[1]  -> \half_empty' := \if (~\alloc[0] | ~\alloc[2] | ~\alloc[3]) \then \true
					 \else \false \fi \\
	~\alloc[2]  -> \half_empty' := \if (~\alloc[0] | ~\alloc[1] | ~\alloc[3]) \then \true
					 \else \false \fi \\
	~\alloc[3]  -> \half_empty' := \if (~\alloc[0] | ~\alloc[1] | ~\alloc[2]) \then \true
					 \else \false \fi \\
	\default    -> \half_empty' := \false
     \end{chtab} \\
\qu \ENDA \\
\qu \ATOM \GRANT_INDEX \CONTROLS \grant_index \\
\qqu \INIT \UPDATE \\
\qqu \begin{chtab}
	true -> grant_index' := nondet
\end{chtab} \\
\qu \ENDA \\
\qu \ATOM \GRANT \CONTROLS \grant
       \READS \alloc
       \AWAITS \req, \high_priority, \half_empty, \grant_index \\
\qqu \INIT \\
\qqu \begin{chtab}
	true -> grant' := false
\end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab} 
	\req' & \high_priority' & ~\alloc[\grant_index'] -> \grant' := \true \\
	\req'  & \half_empty'    & ~\alloc[\grant_index'] -> \grant' :=
	\true \\
	\default -> \grant' := \false
\end{chtab} \\
\qu \ENDA \\
\ENDM \\

\MODULE \Impl \\
\qu \EXTL  \req, \free, \high_priority:\bool; \free_index:\indexType \\
\qu \INTF \grant,\half_empty:bool; grant_index:indexType;
	alloc:regType \\
\qu \PRIV \sum: \sindexType \\
\qu \ATOM \ALLOC \CONTROLS \alloc 
	\READS  \alloc 
	\AWAITS \req, \grant, \grant_index, \free, \free_index \\
\qqu \INIT\\
\qqu \begin{chtab}
	\true -> \forall i \alloc'[i] := \false
     \end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab}
	\true -> \forall i 
		   \alloc'[i] := 
		     \if (\grant' & \grant_index' = i) \then \true
		     \else \if (\free' & \free_index' = i) \then \false
		     \else \alloc[i] \fi \fi 
     \end{chtab} \\
\qu \ENDA \\
\qu \ATOM \SUM \CONTROLS \sum
  	\READS \sum, \alloc
	\AWAITS \grant, \free, \free_index \\
	
\qqu \INIT \\
\qqu \begin{chtab}
	true -> sum' := 0 
\end{chtab}
\qqu \UPDATE \\
\qqu \begin{chtab}
	\grant' & ~(\free' & \alloc[\free_index']) -> \sum' := \sum + 1	
	~\grant' & (\free' & \alloc[\free_index']) -> \sum' := \sum - 1
\end{chtab}
\qu \ENDA
\qu \ATOM \HALF_EMPTY \CONTROLS \half_empty
	\READS \sum \\
\qqu \INIT \\
\qqu \begin{chtab}
	-- complete this
\end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab}
	-- complete this
\end{chtab} \\
\qu \ENDA \\
\qu \ATOM \GRANT_INDEX \CONTROLS \grant_index
	\READS \alloc \\
\qqu \INIT \\
\qqu \begin{chtab}
	\true -> \grant_index' := 0
\end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab}
	~\alloc[0] -> \grant_index' := 0
	\alloc[0] & ~\alloc[1] -> \grant_index' := 1
	\alloc[0] &  \alloc[1] & ~\alloc[2] -> \grant_index' := 2
	\alloc[0] &  \alloc[1] &  \alloc[2] -> \grant_index' := 3
\end{chtab} \\
\qu \ENDA \\
\qu \ATOM \GRANT \CONTROLS \grant
       \READS \alloc, \sum
       \AWAITS \req, \high_priority \\
\qqu \INIT \\
\qqu \begin{chtab}
	-- complete this 
\end{chtab} \\
\qqu \UPDATE \\
\qqu \begin{chtab}
	-- complete this
\end{chtab} \\
\qu \ENDA \\
\ENDM

\end{mtab}

\caption{Resource manager}
\label{fig:rmanager}
\end{figure}

}







 



